name: Bandit SAST Scan

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  security-events: write

jobs:
  bandit:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit with SARIF support
        run: pip install bandit[sarif]

      - name: Run Bandit with baseline
        run: |
          set +e  
          echo "üîç Running Bandit Security Scan"

          if [ -f bandit-baseline.json ]; then
            echo "üìÑ Baseline found ‚Äî comparing against bandit-baseline.json"

            bandit -r . \
                   -f json \
                   -o /tmp/bandit-temp.json \
                   --baseline bandit-baseline.json \
                   -lll -iii

            EXIT_CODE=$?

            echo "Bandit exit code: $EXIT_CODE"

            if [ "$EXIT_CODE" -eq 2 ]; then
              echo "‚ùå New security issues detected that are NOT in baseline!"
              exit 1
            fi

            if [ "$EXIT_CODE" -ne 0 ]; then
              echo "‚ö† Bandit encountered an internal error (EXIT: $EXIT_CODE)"
              exit $EXIT_CODE
            fi

            echo "‚úÖ No new issues found."

          else
            echo "‚ö† No baseline found. Running normal Bandit scan (not failing)."

            bandit -r . \
                   -f json \
                   -o /tmp/bandit-temp.json \
                   -lll -iii || true
          fi

      - name: Generate SARIF report
        run: |
          bandit -r . \
                 -f sarif \
                 -o bandit-report.sarif \
                 -lll -iii

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit-report.sarif